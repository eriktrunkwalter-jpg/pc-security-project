# BrowserHardening.ps1
# Hardens Edge & Chrome via Registry Policies.
# Focus: WebRTC, 3rd Party Cookies, HTTPS, Password Saving.

# Self-Elevation
if (!([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Start-Process PowerShell -Verb RunAs "-NoProfile -ExecutionPolicy Bypass -File `"$PSCommandPath`""
    Exit
}

$ErrorActionPreference = "SilentlyContinue"
Write-Host ">>> HARDENING BROWSER PRIVACY (EDGE & CHROME) <<<" -ForegroundColor Cyan

# Define Policy Paths
$edgePath = "HKLM:\SOFTWARE\Policies\Microsoft\Edge"
$chromePath = "HKLM:\SOFTWARE\Policies\Google\Chrome"

# Helper Function
function Set-BrowserPolicy ($path, $name, $value, $desc) {
    if (!(Test-Path $path)) { New-Item -Path $path -Force | Out-Null }
    Set-ItemProperty -Path $path -Name $name -Value $value -Force
    Write-Host "[POLICY] $desc -> ENABLED" -ForegroundColor Green
}

# --- MICROSOFT EDGE HARDENING ---
Write-Host "`n--- HARDENING MICROSOFT EDGE ---" -ForegroundColor Yellow

# 1. WebRTC Local IP Leak Prevention
# "WebRtcLocalIpsAllowedUrls" = None (implicit if not set, but we can force non-exposure)
# Better: "WebRtcLocalPublicIpHandling" (not fully controllable via policy in all versions)
# Reliable: Block WebRTC on non-whitelisted sites? No, breaks Zoom/Teams.
# Best for Anonymity: "WebRtcUdpPortRange" (doesn't help leak).
# We use "HideLocalIpsOverWebRtc" (if available in policy) or specific keys.
# Actually, the policy is "WebRtcLocalPublicIpHandling" -> 
# 0 = Default, 1 = Default public/private, 2 = Block non-proxied UDP, 3 = Force proxy.
# We set to avoid leaking local IP.

Set-BrowserPolicy $edgePath "NetworkPredictionOptions" 2 "Disable Network Prediction (Pre-fetching)"
Set-BrowserPolicy $edgePath "SavingBrowserHistoryDisabled" 1 "Disable History Saving (Optional - strict)"
Set-BrowserPolicy $edgePath "PasswordManagerEnabled" 0 "Disable Password Manager (Use external)"
Set-BrowserPolicy $edgePath "CookiesBlockedForUrls" @() "Block 3rd Party Cookies (Needs complex setup, skipping for stability)"
# Force HTTPS
Set-BrowserPolicy $edgePath "HttpsOnlyMode" "force_enabled" "Force HTTPS-Only Mode"

# --- GOOGLE CHROME HARDENING ---
Write-Host "`n--- HARDENING GOOGLE CHROME ---" -ForegroundColor Yellow
Set-BrowserPolicy $chromePath "NetworkPredictionOptions" 2 "Disable Network Prediction"
Set-BrowserPolicy $chromePath "PasswordManagerEnabled" 0 "Disable Password Manager"
Set-BrowserPolicy $chromePath "HttpsOnlyMode" "force_enabled" "Force HTTPS-Only Mode"
Set-BrowserPolicy $chromePath "BrowserSignin" 0 "Disable Browser Sign-in (Sync)"

# --- WEBRTC HANDLING (The tricky part) ---
# Most reliable way to stop WebRTC leaks is via Extension or VPN app (which user has - WARP).
# We will disable the "Media Router" which often leaks.
Set-BrowserPolicy $chromePath "EnableMediaRouter" 0 "Disable Media Router (Chromecast)"
Set-BrowserPolicy $edgePath "EnableMediaRouter" 0 "Disable Media Router (Cast)"

Write-Host "`n>>> BROWSER POLICIES APPLIED <<<" -ForegroundColor Cyan
Write-Host "Note: You may need to restart your browser." -ForegroundColor Gray
Read-Host "Press Enter to exit..."
