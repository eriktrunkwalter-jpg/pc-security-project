# AutoIdentityRotator.ps1
# Automates Identity Rotation (New Circuit/IP + System Cleaning)
# NOW WITH RANDOMIZED INTERVALS (Anti-Timing-Analysis)

param(
    [int]$MinMinutes = 3,
    [int]$MaxMinutes = 10,
    [switch]$AggressiveCleanup = $true # Clears Clipboard, ARP, Recent Items
)

# Self-Elevation (Needed to restart service and flush ARP)
if (!([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Start-Process PowerShell -Verb RunAs "-NoProfile -ExecutionPolicy Bypass -File `"$PSCommandPath`""
    Exit
}

$ErrorActionPreference = "SilentlyContinue"
Clear-Host
Write-Host ">>> AUTO IDENTITY ROTATOR (GHOST MODE: ENHANCED) <<<" -ForegroundColor Cyan
Write-Host "Status: ACTIVE" -ForegroundColor Green
Write-Host "Interval: RANDOMIZED between $MinMinutes and $MaxMinutes minutes" -ForegroundColor Yellow
Write-Host "Protection: IP Rotation, DNS Flush, ARP Clear, Clipboard Wipe"
Write-Host "Press [CTRL+C] to Stop."
Write-Host "---------------------------------------------------"

# Locate Tor Binary (reusing logic)
$torProcName = "tor"

$firstRun = $true

while ($true) {
    # 1. CALCULATE RANDOM INTERVAL
    $randomDelay = Get-Random -Minimum ($MinMinutes * 60) -Maximum ($MaxMinutes * 60)
    $nextTime = (Get-Date).AddSeconds($randomDelay).ToString("HH:mm:ss")
    $intervalDesc = [math]::Round($randomDelay / 60, 1)
    
    if (-not $firstRun) {
        Write-Host "`n[$(Get-Date -Format 'HH:mm:ss')] > Waiting $intervalDesc minutes (Next: $nextTime)..." -ForegroundColor Gray
        Start-Sleep -Seconds $randomDelay
    } else {
        Write-Host "`n[$(Get-Date -Format 'HH:mm:ss')] > First Run: Rotating Immediately..." -ForegroundColor Cyan
        $firstRun = $false
    }

    $timestamp = Get-Date -Format "HH:mm:ss"
    Write-Host "[$timestamp] !!! ROTATING IDENTITY NOW !!!" -ForegroundColor Magenta
    
    # 2. STOP TOR
    Stop-Process -Name $torProcName -Force -ErrorAction SilentlyContinue
    
    # 3. START TOR (New Process = New Circuit)
    $torPath = "C:\Program Files\Tor Browser\Browser\TorBrowser\Tor\tor.exe"
    if (!(Test-Path $torPath)) {
        $torPath = "$env:USERPROFILE\OneDrive\Desktop\Tor Browser\Browser\TorBrowser\Tor\tor.exe"
    }
    if (!(Test-Path $torPath)) {
        $torPath = "$env:USERPROFILE\Desktop\Tor Browser\Browser\TorBrowser\Tor\tor.exe"
    }
    if (!(Test-Path $torPath)) {
        $torPath = (Get-Command "tor" -ErrorAction SilentlyContinue).Source
    }

    if ($torPath -and (Test-Path $torPath)) {
        $torConfig = "$env:TEMP\torrc_custom" 
        $torLog = "$env:TEMP\tor_debug.log"
        
        # Ensure torrc exists
        $torrcContent = @"
SocksPort 9050
SafeLogging 1
Log notice file $torLog
DataDirectory $env:TEMP\tor_data
"@
        Set-Content -Path $torConfig -Value $torrcContent

        $torDir = Split-Path -Parent $torPath
        Start-Process -FilePath $torPath -ArgumentList "-f `"$torConfig`"" -WorkingDirectory $torDir -WindowStyle Hidden
        Write-Host "   + New Tor Circuit: REQUESTED" -ForegroundColor Green
    } else {
        Write-Host "   ! ERROR: Tor executable not found." -ForegroundColor Red
    }
    
    # 4. NETWORK & SYSTEM CLEANUP
    Write-Host "   + Flushing DNS Cache..." -NoNewline
    Clear-DnsClientCache
    Write-Host " Done." -ForegroundColor Green

    # 4b. SYSTEM IDENTITY ROTATION (Live Artifacts)
    try {
        $newGuid = [guid]::NewGuid().ToString()
        Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Cryptography" -Name "MachineGuid" -Value $newGuid -ErrorAction SilentlyContinue
        Write-Host "   + Rotated MachineGuid: $newGuid" -ForegroundColor Green
    } catch { Write-Host "   ! Failed to rotate MachineGuid (Rights?)" -ForegroundColor Red }

    # Enforce UTC
    cmd /c "tzutil /s 'UTC'" | Out-Null
    Write-Host "   + Enforced Timezone: UTC" -ForegroundColor Green

    if ($AggressiveCleanup) {
        Write-Host "   + Clearing ARP Cache (Network Neighbors)..." -NoNewline
        cmd /c "arp -d *" | Out-Null
        Write-Host " Done." -ForegroundColor Green

        Write-Host "   + Wiping Clipboard..." -NoNewline
        Set-Clipboard -Value $null
        Write-Host " Done." -ForegroundColor Green
        
        # Optional: Clear Recent File History
        Remove-Item "$env:APPDATA\Microsoft\Windows\Recent\*" -Force -Recurse -ErrorAction SilentlyContinue
        Write-Host "   + Cleared 'Recent Files' List." -ForegroundColor Green

        # --- NEW: SYSTEM IDENTITY ROTATION ---
        Write-Host "   + Rotating System Identity (GUID, Hostname, UTC)..." -NoNewline
        
        # 1. MachineGUID (Tracking ID)
        $guidPath = "HKLM:\SOFTWARE\Microsoft\Cryptography"
        Set-ItemProperty -Path $guidPath -Name "MachineGuid" -Value ([Guid]::NewGuid().ToString()) -Force -ErrorAction SilentlyContinue

        # 2. Hostname (Registry Spoofing - effective fully after reboot, but changes artifacts now)
        $rndName = "DESKTOP-" + -join ((65..90) + (48..57) | Get-Random -Count 7 | ForEach-Object {[char]$_})
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\ComputerName\ComputerName" -Name "ComputerName" -Value $rndName -Force -ErrorAction SilentlyContinue
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\ComputerName\ActiveComputerName" -Name "ComputerName" -Value $rndName -Force -ErrorAction SilentlyContinue

        # 3. Enforce UTC Timezone (Best for Anonymity - prevents leaks)
        # Randomizing Timezone is BAD because it creates mismatches with the IP (e.g. IP in France, Timezone in Tokyo).
        # UTC is the universal standard for privacy (Tor Browser uses it).
        Set-TimeZone -Id "UTC" -ErrorAction SilentlyContinue

        Write-Host " Done." -ForegroundColor Green
    }

    Write-Host "[$timestamp] > IDENTITY ROTATED. SYSTEM CLEAN." -ForegroundColor Cyan
}
