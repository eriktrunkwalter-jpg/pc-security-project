# VerifyAnonymityStatus.ps1
# Verifies the current anonymity status (IP, ISP, Proxy, Tor, DNS).
# Detects if traffic is correctly routed through the Tor network.

$ErrorActionPreference = "SilentlyContinue"

# Removed Self-Elevation to allow inline output capture
# (HKCU and Get-Process do not require Admin)

Write-Host ">>> ANONYMITY STATUS CHECK <<<" -ForegroundColor Cyan

# 1. CHECK TOR PROCESS
Write-Host "[PROCESS] Checking Tor Background Service..." -NoNewline
$torProc = Get-Process -Name "tor" -ErrorAction SilentlyContinue

# Fallback: Check if port 9050 is listening (Tor might be running as service or different user)
if (-not $torProc) {
    $portCheck = Get-NetTCPConnection -LocalPort 9050 -State Listen -ErrorAction SilentlyContinue
    if ($portCheck) {
        $torProc = $true # Pseudo-true for logic
        Write-Host " RUNNING (Port 9050 Active, PID: $($portCheck.OwningProcess))" -ForegroundColor Green
    } else {
        Write-Host " NOT RUNNING (Critical Alert!)" -ForegroundColor Red
    }
} else {
    Write-Host " RUNNING (PID: $($torProc.Id))" -ForegroundColor Green
}

# 2. CHECK SYSTEM PROXY SETTINGS (Registry)
Write-Host "[PROXY] Checking Registry Settings..." -NoNewline
$proxyPath = "HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings"
$proxyEnable = Get-ItemProperty -Path $proxyPath -Name "ProxyEnable" -ErrorAction SilentlyContinue
$proxyServer = Get-ItemProperty -Path $proxyPath -Name "ProxyServer" -ErrorAction SilentlyContinue

if ($proxyEnable.ProxyEnable -eq 1 -and $proxyServer.ProxyServer -match "127.0.0.1:9050") {
    Write-Host " ENFORCED (SOCKS=127.0.0.1:9050)" -ForegroundColor Green
} else {
    Write-Host " NOT CONFIGURED CORRECTLY" -ForegroundColor Red
    Write-Host "   Current: Enable=$($proxyEnable.ProxyEnable), Server=$($proxyServer.ProxyServer)" -ForegroundColor Gray
}

# 3. CHECK NETWORK IDENTITY (External IP)
Write-Host "[NETWORK] Fetching External Identity..." 

# Try Curl via SOCKS5 first (Most accurate for Tor)
$torIP = $null
try {
    # Increased timeout to 20s for Tor latency
    $torIP = (curl.exe -x socks5h://127.0.0.1:9050 -s --max-time 20 ifconfig.me).Trim()
} catch {}

if ($torIP -and $torIP -match "^\d+\.\d+\.\d+\.\d+$") {
    Write-Host "   IP Address: $torIP (via Tor/SOCKS5)" -ForegroundColor Green
    Write-Host "   STATUS    : ANONYMOUS (Tor Circuit Active)" -ForegroundColor Green
} else {
    # Fallback to standard check (might hit WARP/VPN)
    try {
        $ipInfo = Invoke-RestMethod -Uri "http://ip-api.com/json" -ErrorAction Stop
        Write-Host "   IP Address: $($ipInfo.query)" -ForegroundColor Yellow
        Write-Host "   ISP       : $($ipInfo.isp)" -ForegroundColor Yellow
        Write-Host "   Org       : $($ipInfo.org)" -ForegroundColor Yellow
        Write-Host "   Location  : $($ipInfo.country)" -ForegroundColor Yellow
        
        if ($ipInfo.org -match "Cloudflare" -or $ipInfo.isp -match "Cloudflare") {
             Write-Host "   STATUS    : WARP/VPN DETECTED (Tor might be bypassed by this script)" -ForegroundColor Yellow
        }
    } catch {
        Write-Host "   [!] Could not fetch IP details." -ForegroundColor Red
    }
}

# 4. CHECK TIMEZONE LEAK
$localTZ = (Get-TimeZone).Id
Write-Host "[SYSTEM] Checking Timezone Leak..." -NoNewline
Write-Host " System TZ: $localTZ" -ForegroundColor Gray
if ($country -and $country -ne "Germany" -and $localTZ -match "W. Europe") {
     Write-Host "   WARNING: Timezone Mismatch (IP in $country, System in $localTZ)." -ForegroundColor Yellow
     Write-Host "   Browser JavaScript can detect this discrepancy." -ForegroundColor Yellow
} elseif ($localTZ -eq "UTC") {
     Write-Host "   STATUS    : SAFE (UTC Enforced)" -ForegroundColor Green
}

# 5. CHECK IDENTITY ROTATION (Registry)
Write-Host "[IDENTITY] Checking System Artifacts..." 
$regName = (Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\ComputerName\ComputerName" -Name "ComputerName" -ErrorAction SilentlyContinue).ComputerName
$regGuid = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Cryptography" -Name "MachineGuid" -ErrorAction SilentlyContinue).MachineGuid

Write-Host "   Hostname (Reg): $regName" -ForegroundColor Gray
Write-Host "   MachineGUID   : $regGuid" -ForegroundColor Gray

if ($regName -match "^DESKTOP-[A-Z0-9]{7}$") {
    Write-Host "   STATUS    : RANDOMIZED (Pattern Matches)" -ForegroundColor Green
} else {
    Write-Host "   STATUS    : STATIC (Might be original name)" -ForegroundColor Yellow
}

Write-Host "`n---------------------------------------------------"
# Read-Host "Press Enter to exit..."
