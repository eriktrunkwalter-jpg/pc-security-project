# DisableRecentHistoryAdmin.ps1
# Disables Windows "Recent Items" tracking permanently via Admin policies.
# Self-elevates to ensure Registry access.

# Self-Elevation to Administrator
if (!([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Start-Process PowerShell -Verb RunAs "-NoProfile -ExecutionPolicy Bypass -File `"$PSCommandPath`""
    Exit
}

$ErrorActionPreference = "SilentlyContinue"
Write-Host ">>> DISABLING RECENT FILE HISTORY (ADMIN) <<<" -ForegroundColor Cyan

# 1. Disable in Current User (Advanced Settings)
$pathAdvanced = "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced"
Write-Host "Setting Start_TrackDocs to 0..."
Set-ItemProperty -Path $pathAdvanced -Name "Start_TrackDocs" -Value 0 -Force
Write-Host "   -> Done." -ForegroundColor Green

# 2. Disable via Policy (Current User)
$pathPolicyCU = "HKCU:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer"
if (!(Test-Path $pathPolicyCU)) { 
    New-Item -Path $pathPolicyCU -Force | Out-Null 
    Write-Host "   -> Created User Policy Key."
}
Write-Host "Setting NoRecentDocsHistory (User Policy)..."
Set-ItemProperty -Path $pathPolicyCU -Name "NoRecentDocsHistory" -Value 1 -Force
Write-Host "   -> Done." -ForegroundColor Green

# 3. Disable via Policy (Local Machine - System Wide)
$pathPolicyLM = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer"
if (!(Test-Path $pathPolicyLM)) { 
    New-Item -Path $pathPolicyLM -Force | Out-Null 
    Write-Host "   -> Created System Policy Key."
}
Write-Host "Setting NoRecentDocsHistory (System Policy)..."
Set-ItemProperty -Path $pathPolicyLM -Name "NoRecentDocsHistory" -Value 1 -Force
Write-Host "   -> Done." -ForegroundColor Green

# 4. Clear existing history
Write-Host "Clearing existing Recent Items..."
$recentPath = "$env:APPDATA\Microsoft\Windows\Recent"
Get-ChildItem -Path $recentPath -Recurse -Force -ErrorAction SilentlyContinue | Remove-Item -Force -Recurse -ErrorAction SilentlyContinue
Write-Host "   -> Cleared." -ForegroundColor Green

# 5. Restart Explorer to apply
Write-Host "Restarting Windows Explorer to apply changes..."
Stop-Process -Name explorer -Force
Start-Sleep -Seconds 2
if (!(Get-Process explorer -ErrorAction SilentlyContinue)) {
   Start-Process explorer
}

Write-Host "`n>>> HISTORY TRACKING PERMANENTLY DISABLED <<<" -ForegroundColor Cyan
Read-Host "Press Enter to exit..."
