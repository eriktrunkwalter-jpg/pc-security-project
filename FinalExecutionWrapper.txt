# FinalExecutionWrapper.ps1
# EXECUTING ALL FINAL STEPS:
# 1. Install Ghost Protocols (Autostart)
# 2. Install Panic Guard (Autostart)
# 3. Disable Webcam
# 4. Enable Firewall Kill Switch

if (!([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Start-Process PowerShell -Verb RunAs "-NoProfile -ExecutionPolicy Bypass -File `"$PSCommandPath`""
    Exit
}

$ErrorActionPreference = "SilentlyContinue"
$baseDir = "$env:USERPROFILE\Documents\trae_projects\pc"

Write-Host ">>> FINAL SYSTEM EXECUTION INITIATED <<<" -ForegroundColor Magenta
Write-Host "Applying all security layers..."

# 1. Disable Webcam
Write-Host "`n[1] DISABLING WEBCAM..." -ForegroundColor Yellow
Start-Process PowerShell -ArgumentList "-ExecutionPolicy Bypass -File `"$baseDir\DisableWebcam.ps1`"" -Wait

# 2. Install Ghost Protocols (Rotator Autostart)
Write-Host "`n[2] INSTALLING GHOST PROTOCOLS..." -ForegroundColor Yellow
Start-Process PowerShell -ArgumentList "-ExecutionPolicy Bypass -File `"$baseDir\InstallGhostProtocols.ps1`"" -Wait

# 3. Install Panic Guard (PanicButton Autostart)
Write-Host "`n[3] INSTALLING PANIC GUARD..." -ForegroundColor Yellow
# Register PanicGuard as a Scheduled Task (AtLogon)
$panicScript = "$baseDir\PanicGuard.ps1"
$taskName = "PanicGuard"
$action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-ExecutionPolicy Bypass -WindowStyle Hidden -File `"$panicScript`""
$trigger = New-ScheduledTaskTrigger -AtLogon
$settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable -Hidden -ExecutionTimeLimit (New-TimeSpan -Days 365) # Run forever
Unregister-ScheduledTask -TaskName $taskName -Confirm:$false -ErrorAction SilentlyContinue
Register-ScheduledTask -TaskName $taskName -Action $action -Trigger $trigger -Settings $settings -User "System" -RunLevel Highest -Force | Out-Null
Write-Host "   + PanicGuard registered to start automatically." -ForegroundColor Green

# 4. Enable Firewall Kill Switch
Write-Host "`n[4] ENABLING FIREWALL KILL SWITCH (NUCLEAR OPTION)..." -ForegroundColor Yellow
# We run this last because it might cut connectivity if Tor isn't ready.
# We launch it but don't wait, or we just execute it.
Start-Process PowerShell -ArgumentList "-ExecutionPolicy Bypass -File `"$baseDir\EnableFirewallKillSwitch.ps1`"" -Wait

Write-Host "`n>>> ALL SYSTEMS GO. REBOOTING IN 10 SECONDS... <<<" -ForegroundColor Red
Start-Sleep -Seconds 10
Restart-Computer -Force
