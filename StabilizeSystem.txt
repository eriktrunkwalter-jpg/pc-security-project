# StabilizeSystem.ps1
# Fixes Crash Issues by Disabling Forced Hypervisor/VBS checks

$LogFile = "$env:USERPROFILE\Documents\trae_projects\pc\Stabilization_Log.txt"
Start-Transcript -Path $LogFile -Force

Write-Host ">>> SYSTEM STABILIZATION STARTED <<<" -ForegroundColor Cyan

# 1. Fix Hypervisor/VBS Crash (Event ID 41 / Hypervisor launch failed)
# The system crashes because VBS is forced but BIOS VMX is disabled.
Write-Host "Disabling Forced Virtualization Based Security (VBS) to prevent boot crashes..." -ForegroundColor Yellow

$VBSKeys = @(
    "HKLM:\SYSTEM\CurrentControlSet\Control\DeviceGuard",
    "HKLM:\SYSTEM\CurrentControlSet\Control\DeviceGuard\Scenarios\HypervisorEnforcedCodeIntegrity"
)

foreach ($key in $VBSKeys) {
    if (Test-Path $key) {
        # Set EnableVirtualizationBasedSecurity to 0 (Disabled) to stop crash
        Set-ItemProperty -Path $key -Name "EnableVirtualizationBasedSecurity" -Value 0 -Type DWord -ErrorAction SilentlyContinue
        Set-ItemProperty -Path $key -Name "Enabled" -Value 0 -Type DWord -ErrorAction SilentlyContinue
        Write-Host "   Disabled VBS enforcement in $key" -ForegroundColor Green
    }
}

# 2. Cleanup "Red Team" Leftovers
Write-Host "`nCleaning up simulation artifacts..." -ForegroundColor Yellow
$Service = Get-Service -Name "TraeMalware" -ErrorAction SilentlyContinue
if ($Service) {
    Write-Host "   Removing test service 'TraeMalware'..."
    Stop-Service "TraeMalware" -Force -ErrorAction SilentlyContinue
    sc.exe delete "TraeMalware" | Out-Null
    Write-Host "   Service deleted." -ForegroundColor Green
}

# 3. Final BitLocker Check (Non-Intrusive)
Write-Host "`nChecking BitLocker Encryption Status..." -ForegroundColor Yellow
try {
    $bl = Get-BitLockerVolume -MountPoint "C:" -ErrorAction SilentlyContinue
    if ($bl) {
        Write-Host "   Status: $($bl.VolumeStatus)" -ForegroundColor Green
        Write-Host "   Method: $($bl.EncryptionMethod)" -ForegroundColor Green
        Write-Host "   Percent: $($bl.EncryptionPercentage)%" -ForegroundColor Green
    } else {
        Write-Host "   Could not query via PowerShell. Try 'manage-bde -status' as Admin." -ForegroundColor Yellow
    }
} catch {
    Write-Host "   Access denied to BitLocker status. (Expected if not Admin)"
}

Write-Host "`n>>> STABILIZATION COMPLETE <<<" -ForegroundColor Cyan
Stop-Transcript

