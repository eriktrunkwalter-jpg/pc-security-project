# NuclearRedTeamAudit.ps1
# THE NUCLEAR OPTION: Extreme Security, Anonymity & Forensics Audit.
# Checks: LSA, CredGuard, Hibernation, Pagefile, MRU, Ports, Proxies, Shadows, and more.

# Self-Elevation
if (!([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Start-Process PowerShell -Verb RunAs "-NoProfile -ExecutionPolicy Bypass -File `"$PSCommandPath`""
    Exit
}

$ErrorActionPreference = "SilentlyContinue"
$reportFile = "$env:USERPROFILE\Documents\trae_projects\pc\NuclearAuditReport.txt"
"=== NUCLEAR RED TEAM AUDIT REPORT ===" | Out-File -FilePath $reportFile -Encoding utf8
"Date: $(Get-Date)" | Out-File -FilePath $reportFile -Append -Encoding utf8
"------------------------------------------------" | Out-File -FilePath $reportFile -Append -Encoding utf8

function Log-Attack ($name, $vector, $result, $details) {
    $statusColor = if ($result -eq "BLOCKED") { "Green" } elseif ($result -eq "VULNERABLE") { "Red" } else { "Yellow" }
    Write-Host "TEST: $name ($vector)" -NoNewline
    Write-Host " -> $result" -ForegroundColor $statusColor
    if ($details) { Write-Host "   Context: $details" -ForegroundColor Gray }
    
    "[$result] $name ($vector) - $details" | Out-File -FilePath $reportFile -Append -Encoding utf8
}

function Log-ToFile ($msg) {
    $msg | Out-File -FilePath $reportFile -Append -Encoding utf8
}

Write-Host "`n>>> INITIATING NUCLEAR AUDIT <<<`n" -ForegroundColor Red

# --- PHASE 1: CREDENTIAL THEFT & LSA ---
Write-Host "--- LEVEL 1: CREDENTIAL & MEMORY PROTECTION ---" -ForegroundColor Magenta

# 1. LSA Protection (RunAsPPL)
$lsa = Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa" -Name "RunAsPPL" -ErrorAction SilentlyContinue
if ($lsa.RunAsPPL -eq 1) {
    Log-Attack "Mimikatz" "LSA Protection" "BLOCKED" "RunAsPPL active"
} else {
    Log-Attack "Mimikatz" "LSA Protection" "VULNERABLE" "LSA not running as PPL"
}

# 2. Credential Guard (Virtualization)
$credGuard = Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa" -Name "LsaCfgFlags" -ErrorAction SilentlyContinue
if ($credGuard.LsaCfgFlags -eq 1 -or $credGuard.LsaCfgFlags -eq 2) {
    Log-Attack "CredDump" "Credential Guard" "BLOCKED" "Credential Guard Active"
} else {
    Log-Attack "CredDump" "Credential Guard" "VULNERABLE" "Credential Guard disabled (or no VBS)"
}

# 3. AlwaysInstallElevated (Registry PrivEsc)
$installElevatedHKLM = Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\Installer" -Name "AlwaysInstallElevated" -ErrorAction SilentlyContinue
$installElevatedHKCU = Get-ItemProperty -Path "HKCU:\SOFTWARE\Policies\Microsoft\Windows\Installer" -Name "AlwaysInstallElevated" -ErrorAction SilentlyContinue
if ($installElevatedHKLM.AlwaysInstallElevated -eq 1 -or $installElevatedHKCU.AlwaysInstallElevated -eq 1) {
    Log-Attack "PrivEsc" "AlwaysInstallElevated" "CRITICAL" "MSI Installers run as SYSTEM!"
} else {
    Log-Attack "PrivEsc" "AlwaysInstallElevated" "BLOCKED" "Safe"
}

# --- PHASE 2: FORENSICS & DATA RESIDUE ---
Write-Host "`n--- LEVEL 2: FORENSICS & ANTI-ANALYSIS ---" -ForegroundColor Magenta

# 4. Hibernation File (RAM Dump to Disk)
if (Test-Path "C:\hiberfil.sys") {
    Log-Attack "Forensics" "Hibernation File" "VULNERABLE" "hiberfil.sys exists (RAM saved to disk)"
} else {
    Log-Attack "Forensics" "Hibernation File" "BLOCKED" "Hibernation disabled"
}

# 5. Pagefile Wipe at Shutdown
$mem = Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" -Name "ClearPageFileAtShutdown" -ErrorAction SilentlyContinue
if ($mem.ClearPageFileAtShutdown -eq 1) {
    Log-Attack "Forensics" "Pagefile Wipe" "BLOCKED" "Wipes at shutdown"
} else {
    Log-Attack "Forensics" "Pagefile Wipe" "VULNERABLE" "Pagefile persists after shutdown"
}

# 6. Shadow Copies (VSS)
$shadows = vssadmin list shadows 2>&1
if ($shadows -match "No items found" -or $shadows -eq $null) {
    Log-Attack "Forensics" "Shadow Copies" "BLOCKED" "No Shadow Copies found"
} else {
    Log-Attack "Forensics" "Shadow Copies" "WARNING" "Shadow Copies exist (Recoverable data)"
}

# 7. Recent Docs (MRU Lists)
$recent = Get-ChildItem "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\RecentDocs" -Recurse -ErrorAction SilentlyContinue | Measure-Object
if ($recent.Count -gt 5) { # Arbitrary low number
    Log-Attack "Privacy" "Recent Docs MRU" "LEAKING" "Found $($recent.Count) MRU entries in Registry"
} else {
    Log-Attack "Privacy" "Recent Docs MRU" "CLEAN" "Minimal MRU entries found"
}

# --- PHASE 3: NETWORK PARANOIA ---
Write-Host "`n--- LEVEL 3: NETWORK PARANOIA ---" -ForegroundColor Magenta

# 8. Open Ports (Listening)
$listeners = Get-NetTCPConnection -State Listen -ErrorAction SilentlyContinue | Where-Object { $_.LocalAddress -ne "127.0.0.1" -and $_.LocalAddress -ne "::1" }
$count = ($listeners | Measure-Object).Count
if ($count -gt 5) {
    Log-Attack "Network" "Open Ports" "WARNING" "Found $count listening ports on external interfaces"
    $listeners | Select-Object -First 3 | ForEach-Object { Log-ToFile "   - Port $($_.LocalPort) ($($_.OwningProcess))" }
} else {
    Log-Attack "Network" "Open Ports" "SECURE" "Minimal open ports detected ($count)"
}

# 9. Proxy Settings
$proxy = netsh winhttp show proxy
if ($proxy -match "Direct Access" -or $proxy -match "no proxy") {
    Log-Attack "Network" "Global Proxy" "CLEAN" "No malicious global proxy found"
} else {
    Log-Attack "Network" "Global Proxy" "WARNING" "Proxy detected (Check output)"
    Log-ToFile "   $proxy"
}

# 10. Hosts File
$hostsContent = Get-Content "C:\Windows\System32\drivers\etc\hosts" -ErrorAction SilentlyContinue | Where-Object { $_ -notmatch "^#" -and $_ -ne "" }
if ($hostsContent.Count -gt 0) {
    Log-Attack "Network" "Hosts File" "WARNING" "Custom entries found in Hosts file"
} else {
    Log-Attack "Network" "Hosts File" "CLEAN" "Default Hosts file"
}

# --- PHASE 4: ANONYMITY EXTREMES ---
Write-Host "`n--- LEVEL 4: ANONYMITY EXTREMES ---" -ForegroundColor Magenta

# 11. Advertising ID
$advId = Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\AdvertisingInfo" -Name "Enabled" -ErrorAction SilentlyContinue
if ($advId.Enabled -eq 1) {
    Log-Attack "Tracking" "Advertising ID" "LEAKING" "Ad ID Enabled"
} else {
    Log-Attack "Tracking" "Advertising ID" "BLOCKED" "Ad ID Disabled"
}

# 12. Activity Feed (Timeline)
$feed = Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\System" -Name "EnableActivityFeed" -ErrorAction SilentlyContinue
if ($feed.EnableActivityFeed -eq 0) {
    Log-Attack "Tracking" "Activity Feed" "BLOCKED" "Timeline Disabled"
} else {
    Log-Attack "Tracking" "Activity Feed" "VULNERABLE" "Timeline/Activity Feed might be active"
}

Write-Host "`n>>> NUCLEAR AUDIT COMPLETE. GENERATING REPORT... <<<" -ForegroundColor Cyan
Log-ToFile "------------------------------------------------"
Log-ToFile "NUCLEAR AUDIT END"

