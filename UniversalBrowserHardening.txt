# UniversalBrowserHardening.ps1
# Applies Enterprise Policies to Harden ALL Browsers: Edge, Chrome, Firefox, Brave.
# Features: Anti-Tracking, No Passwords, HTTPS-Only, No Telemetry, No 3rd Party Cookies.

# Self-Elevation
if (!([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Start-Process PowerShell -Verb RunAs "-NoProfile -ExecutionPolicy Bypass -File `"$PSCommandPath`""
    Exit
}

$ErrorActionPreference = "SilentlyContinue"
Write-Host ">>> UNIVERSAL BROWSER HARDENING <<<" -ForegroundColor Cyan

# Define Registry Paths
$policies = @(
    @{ Path = "HKLM:\SOFTWARE\Policies\Microsoft\Edge"; Name = "Edge" },
    @{ Path = "HKLM:\SOFTWARE\Policies\Google\Chrome"; Name = "Chrome" },
    @{ Path = "HKLM:\SOFTWARE\Policies\BraveSoftware\Brave"; Name = "Brave" }
)

# --- CHROMIUM BROWSERS (Edge, Chrome, Brave) ---
foreach ($p in $policies) {
    Write-Host "`n--- Hardening $($p.Name) ---" -ForegroundColor Yellow
    $path = $p.Path
    if (!(Test-Path $path)) { New-Item -Path $path -Force | Out-Null }

    # 1. Network & Privacy
    Set-ItemProperty -Path $path -Name "NetworkPredictionOptions" -Value 2 -Force # Disable Prediction
    Set-ItemProperty -Path $path -Name "HttpsOnlyMode" -Value "force_enabled" -Force # Force HTTPS
    Set-ItemProperty -Path $path -Name "GloballyScopeHTTPAuthCacheEnabled" -Value 0 -Force # Isolate Auth Cache
    Set-ItemProperty -Path $path -Name "EnableMediaRouter" -Value 0 -Force # Disable Cast/WebRTC Leak Source
    
    # 2. Data Protection
    Set-ItemProperty -Path $path -Name "PasswordManagerEnabled" -Value 0 -Force # No Passwords
    Set-ItemProperty -Path $path -Name "SavingBrowserHistoryDisabled" -Value 1 -Force # No History
    Set-ItemProperty -Path $path -Name "AutofillAddressEnabled" -Value 0 -Force # No Address Autofill
    Set-ItemProperty -Path $path -Name "AutofillCreditCardEnabled" -Value 0 -Force # No Credit Card Autofill
    
    # 3. Security
    Set-ItemProperty -Path $path -Name "BrowserSignin" -Value 0 -Force # Disable Sync/Sign-in
    Set-ItemProperty -Path $path -Name "BlockThirdPartyCookies" -Value 1 -Force # Block 3rd Party Cookies (Force)
    Set-ItemProperty -Path $path -Name "UserFeedbackAllowed" -Value 0 -Force # No Feedback
    Set-ItemProperty -Path $path -Name "MetricsReportingEnabled" -Value 0 -Force # No Telemetry
}

# --- FIREFOX HARDENING ---
Write-Host "`n--- Hardening Firefox ---" -ForegroundColor Yellow
$ffPath = "HKLM:\SOFTWARE\Policies\Mozilla\Firefox"
if (!(Test-Path $ffPath)) { New-Item -Path $ffPath -Force | Out-Null }

# 1. Privacy & Telemetry
Set-ItemProperty -Path $ffPath -Name "DisableTelemetry" -Value 1 -Force
Set-ItemProperty -Path $ffPath -Name "DisableFirefoxStudies" -Value 1 -Force
Set-ItemProperty -Path $ffPath -Name "DisablePocket" -Value 1 -Force
Set-ItemProperty -Path $ffPath -Name "DisableFeedbackCommands" -Value 1 -Force

# 2. Security
Set-ItemProperty -Path $ffPath -Name "OfferToSaveLogins" -Value 0 -Force # No Passwords
Set-ItemProperty -Path $ffPath -Name "PasswordManagerEnabled" -Value 0 -Force # No Passwords (Alt)
Set-ItemProperty -Path $ffPath -Name "DNSOverHTTPS" -Value 1 -Force # Enable DoH
Set-ItemProperty -Path $ffPath -Name "EncryptedMediaExtensions" -Value 0 -Force # DRM Block (Optional, but good for privacy)

# 3. Cookies (JSON handling needed for sub-keys usually, but simple keys work for some)
# We set 'Cookies' policy which requires a subkey or JSON structure in some versions,
# but 'NetworkPrediction' is standard.
Set-ItemProperty -Path $ffPath -Name "NetworkPrediction" -Value 0 -Force

Write-Host "`n>>> ALL BROWSERS HARDENED <<<" -ForegroundColor Cyan
Read-Host "Press Enter to exit..."
