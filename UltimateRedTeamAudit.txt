# UltimateRedTeamAudit.ps1
# THE FINAL EXAM: Simulates Simple, Medium, and Heavy attacks.
# Tests Anonymity, Physical Security, and Network Hardening.

# Self-Elevation
if (!([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Start-Process PowerShell -Verb RunAs "-NoProfile -ExecutionPolicy Bypass -File `"$PSCommandPath`""
    Exit
}

$ErrorActionPreference = "SilentlyContinue"
$reportFile = "$env:USERPROFILE\Documents\trae_projects\pc\UltimateAuditReport.txt"
"=== ULTIMATE RED TEAM AUDIT REPORT ===" | Out-File -FilePath $reportFile -Encoding utf8
"Date: $(Get-Date)" | Out-File -FilePath $reportFile -Append -Encoding utf8
"------------------------------------------------" | Out-File -FilePath $reportFile -Append -Encoding utf8

function Log-Attack ($name, $vector, $result, $details) {
    $statusColor = if ($result -eq "BLOCKED") { "Green" } elseif ($result -eq "VULNERABLE") { "Red" } else { "Yellow" }
    Write-Host "ATTACK: $name ($vector)" -NoNewline
    Write-Host " -> $result" -ForegroundColor $statusColor
    if ($details) { Write-Host "   Context: $details" -ForegroundColor Gray }
    
    "[$result] $name ($vector) - $details" | Out-File -FilePath $reportFile -Append -Encoding utf8
}

function Log-ToFile ($msg) {
    $msg | Out-File -FilePath $reportFile -Append -Encoding utf8
}

Write-Host "`n>>> INITIATING ULTIMATE RED TEAM SIMULATION <<<`n" -ForegroundColor Red

# --- PHASE 1: SIMPLE ATTACKS (Script Kiddie) ---
Write-Host "--- LEVEL 1: SCRIPT KIDDIE ATTACKS ---" -ForegroundColor Magenta

# 1. USB Drop Attack (AutoRun)
$autorun = Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer" -Name "NoDriveTypeAutoRun" -ErrorAction SilentlyContinue
if ($autorun.NoDriveTypeAutoRun -eq 255) {
    Log-Attack "USB Payload" "AutoRun" "BLOCKED" "AutoPlay disabled for all drives"
} else {
    Log-Attack "USB Payload" "AutoRun" "VULNERABLE" "AutoPlay might execute payloads"
}

# 2. PowerShell Downgrade (Bypass AMSI)
$psv2 = Get-WindowsOptionalFeature -Online -FeatureName MicrosoftWindowsPowerShellV2 -ErrorAction SilentlyContinue
if ($psv2.State -eq "Disabled") {
    Log-Attack "AMSI Bypass" "PowerShell v2" "BLOCKED" "Legacy Engine Removed"
} else {
    Log-Attack "AMSI Bypass" "PowerShell v2" "VULNERABLE" "PSv2 available for evasion"
}

# 3. Unquoted Service Path (Privilege Escalation)
$unquoted = Get-WmiObject Win32_Service | Where-Object { $_.PathName -notmatch '^"' -and $_.PathName -match ' ' -and $_.PathName -notmatch '^C:\\Windows' }
if ($unquoted) {
    Log-Attack "PrivEsc" "Unquoted Path" "VULNERABLE" "Found $($unquoted.Count) services"
} else {
    Log-Attack "PrivEsc" "Unquoted Path" "BLOCKED" "No vulnerable paths found"
}

# --- PHASE 2: MEDIUM ATTACKS (Hacker in Network) ---
Write-Host "`n--- LEVEL 2: NETWORK & LATERAL MOVEMENT ---" -ForegroundColor Magenta

# 4. Responder / Man-in-the-Middle (LLMNR/NetBIOS)
$llmnr = Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\NT DNSClient" -Name "EnableMulticast" -ErrorAction SilentlyContinue
if ($llmnr.EnableMulticast -eq 0) {
    Log-Attack "MITM Spoofing" "LLMNR" "BLOCKED" "Protocol disabled"
} else {
    Log-Attack "MITM Spoofing" "LLMNR" "VULNERABLE" "LLMNR active"
}

# 5. RDP Brute Force / Exploit
$rdp = Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -ErrorAction SilentlyContinue
if ($rdp.fDenyTSConnections -eq 1) {
    Log-Attack "RDP Exploit" "Port 3389" "BLOCKED" "Service disabled"
} else {
    Log-Attack "RDP Exploit" "Port 3389" "VULNERABLE" "RDP enabled"
}

# 6. Persistence via WMI (ASR Check)
$asrStatus = (Get-MpPreference).AttackSurfaceReductionRules_Ids
if ($asrStatus -contains "e6db77e5-3d12-4cf4-9463-c288586407db") {
    Log-Attack "WMI Persistence" "ASR Rule" "BLOCKED" "Defender blocking WMI subscriptions"
} else {
    Log-Attack "WMI Persistence" "ASR Rule" "WARNING" "ASR Rule not detected (might be managed)"
}

# --- PHASE 3: HEAVY ATTACKS (State Actor / Physical) ---
Write-Host "`n--- LEVEL 3: HEAVY / PHYSICAL ATTACKS ---" -ForegroundColor Magenta

# 7. Cold Boot Attack (Encryption)
$bl = Get-BitLockerVolume -MountPoint C:\
if ($bl.EncryptionMethod -eq "XtsAes256" -and $bl.ProtectionStatus -eq "On") {
    Log-Attack "Cold Boot" "Disk Encryption" "BLOCKED" "XTS-AES 256-bit"
} else {
    Log-Attack "Cold Boot" "Disk Encryption" "VULNERABLE" "Not fully encrypted"
}

# 8. Evil Maid / DMA Attack
$dmaGuard = Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\DmaGuard" -Name "DeviceEnumerationPolicy" -ErrorAction SilentlyContinue
$vbs = Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\DeviceGuard" -Name "EnableVirtualizationBasedSecurity" -ErrorAction SilentlyContinue

if ($dmaGuard.DeviceEnumerationPolicy -eq 1 -or $dmaGuard.DeviceEnumerationPolicy -eq 2) {
    Log-Attack "DMA Injection" "DMA Guard" "MITIGATED" "External DMA blocked when locked"
} elseif ($vbs.EnableVirtualizationBasedSecurity -eq 1) {
    Log-Attack "DMA Injection" "VBS/IOMMU" "BLOCKED" "Memory protected by VBS"
} else {
    Log-Attack "DMA Injection" "Direct Access" "ACCEPTED RISK" "VBS disabled for stability (Physical risk)"
}

# 9. Kernel Rootkit (Secure Boot & Driver Blocklist)
try {
    $sb = Get-SecureBootUEFI -ErrorAction Stop
} catch {
    $sb = [PSCustomObject]@{Status = "Unknown/Error"}
}

$blocklist = Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\CI\Config" -Name "VulnerableDriverBlocklistEnable" -ErrorAction SilentlyContinue

if ($sb.Status -eq "Enabled" -and $blocklist.VulnerableDriverBlocklistEnable -eq 1) {
    Log-Attack "Kernel Rootkit" "Boot Chain" "BLOCKED" "SecureBoot + Driver Blocklist Active"
} else {
    Log-Attack "Kernel Rootkit" "Boot Chain" "WARNING" "Check SecureBoot/Blocklist status"
}

# --- PHASE 4: ANONYMITY (Surveillance) ---
Write-Host "`n--- LEVEL 4: ANONYMITY & SURVEILLANCE ---" -ForegroundColor Magenta

# 10. Data Exfiltration (Telemetry)
$diagTrack = Get-Service "DiagTrack" -ErrorAction SilentlyContinue
if ($diagTrack.StartType -eq "Disabled" -or $diagTrack.Status -eq "Stopped") {
    Log-Attack "Telemetry" "DiagTrack Svc" "BLOCKED" "Service disabled/stopped"
} else {
    Log-Attack "Telemetry" "DiagTrack Svc" "LEAKING" "Service running"
}

# 11. DNS Tracking
$dns = Get-DnsClientServerAddress -InterfaceAlias "Wi-Fi", "Ethernet" | Where-Object {$_.ServerAddresses.Count -gt 0}
$secureDns = $false
foreach ($iface in $dns) {
    if ($iface.ServerAddresses -contains "1.1.1.1" -or $iface.ServerAddresses -contains "9.9.9.9") {
        $secureDns = $true
    }
}
if ($secureDns) {
    Log-Attack "ISP Tracking" "DNS" "BLOCKED" "Using Privacy DNS (Cloudflare/Quad9)"
} else {
    Log-Attack "ISP Tracking" "DNS" "LEAKING" "ISP DNS detected"
}

Write-Host "`n>>> AUDIT COMPLETE. GENERATING REPORT... <<<" -ForegroundColor Cyan
Log-ToFile "------------------------------------------------"
Log-ToFile "AUDIT END"

