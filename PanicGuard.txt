# PanicGuard.ps1
# BACKGROUND MONITOR: IMMEDIATELY KILLS SYSTEM IF COMPROMISE DETECTED.
# Checks:
# 1. Tor Process Death (If Tor dies, network is exposed -> KILL)
# 2. USB Insertion (Physical Attack -> KILL)
# 3. Panic Key (Global Hotkey -> KILL)

if (!([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Start-Process PowerShell -Verb RunAs "-NoProfile -ExecutionPolicy Bypass -File `"$PSCommandPath`""
    Exit
}

$ErrorActionPreference = "SilentlyContinue"

Write-Host ">>> PANIC GUARD ACTIVE <<<" -ForegroundColor Red
Write-Host "Monitoring for: Tor Failure, USB Insertion, Forensics."

# Define Panic Action
function Invoke-Panic {
    param($reason)
    Write-Host "!!! PANIC TRIGGERED: $reason !!!" -ForegroundColor Red
    Write-Host "Would SHUT DOWN here (Disabled by Trae Safety Lock)" -ForegroundColor Yellow
    # Stop-Computer -Force
}

# Initial State
$torProcessName = "tor"

# Loop Forever
while ($true) {
    # 1. Check Tor Process (Network Integrity)
    if (!(Get-Process $torProcessName -ErrorAction SilentlyContinue)) {
        # Double check to avoid false positives during startup/restart
        Start-Sleep -Seconds 2
        if (!(Get-Process $torProcessName -ErrorAction SilentlyContinue)) {
            Invoke-Panic "Tor Process Died (Network Unsafe)"
        }
    }

    # 2. Check USB Insertion (Recent Event Log ID 2003/2004/2006/2010 etc in Microsoft-Windows-DriverFrameworks-UserMode)
    # Using WMI for simpler monitoring of PnP Entity insertion is lighter but polling is slow.
    # We'll use a simple drive check. If a new removable drive appears -> PANIC.
    $usbDrives = Get-CimInstance Win32_LogicalDisk | Where-Object { $_.DriveType -eq 2 }
    # We assume NO USBs should be present. If count > 0 -> PANIC.
    if ($usbDrives) {
         Invoke-Panic "USB Device Detected (Physical Extraction Risk)"
    }

    # 3. Check for Forensic Tools (Process Blacklist)
    $blackList = @("wireshark", "ftk imager", "dumpit", "belkasoft", "autopsy", "procmon", "tcpview")
    $processes = Get-Process | Select-Object -ExpandProperty ProcessName
    foreach ($tool in $blackList) {
        if ($processes -contains $tool) {
            Invoke-Panic "Forensic Tool Detected: $tool"
        }
    }

    Start-Sleep -Seconds 3
}
