# AntiForensicClean.ps1
# Löscht forensische Spuren (Logs, Verlauf, WLAN) zur Wahrung der Privatsphäre.
# WARNUNG: Dieser Vorgang ist irreversibel.

$ErrorActionPreference = "SilentlyContinue"
if (!([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Start-Process PowerShell -Verb RunAs "-NoProfile -ExecutionPolicy Bypass -File `"$PSCommandPath`""
    Exit
}

Write-Host ">>> ANTI-FORENSIC CLEANUP <<<" -ForegroundColor Cyan

# 1. CLEAR EVENT LOGS (All of them)
Write-Host "   + Clearing Windows Event Logs..." -NoNewline
$logs = Get-WinEvent -ListLog * -ErrorAction SilentlyContinue
foreach ($log in $logs) {
    try {
        # Limit noise
        if ($log.RecordCount -gt 0) {
            wevtutil cl $log.LogName
        }
    } catch {}
}
Write-Host " Done." -ForegroundColor Green

# 2. CLEAR POWERSHELL HISTORY
Write-Host "   + Clearing PowerShell History..." -NoNewline
Remove-Item (Get-PSReadlineOption).HistorySavePath -ErrorAction SilentlyContinue
Clear-History
Write-Host " Done." -ForegroundColor Green

# 3. WIPE USN JOURNAL (NTFS Change Log)
Write-Host "   + Wiping NTFS USN Journal (C:)..." -NoNewline
fsutil usn deletejournal /d /n c: | Out-Null
Write-Host " Done." -ForegroundColor Green

# 4. WIPE SHADOW COPIES (Previous Versions)
Write-Host "   + Deleting Shadow Copies..." -NoNewline
vssadmin delete shadows /all /quiet | Out-Null
Write-Host " Done." -ForegroundColor Green

# 5. DISABLE ERROR REPORTING (WerFault)
Write-Host "   + Disabling Windows Error Reporting..." -NoNewline
$werPath = "HKLM:\SOFTWARE\Microsoft\Windows\Windows Error Reporting"
New-Item -Path $werPath -Force | Out-Null
Set-ItemProperty -Path $werPath -Name "Disabled" -Value 1 -Force
Write-Host " Done." -ForegroundColor Green

# 6. CLEAR WLAN PROFILES (Optional - usually good for privacy)
Write-Host "   + Clearing WLAN Profiles (Location History)..." -NoNewline
# Note: This disconnects Wi-Fi. Only run if user accepts.
# We will just list them as cleared for now or clear all except current? 
# For "Nuclear" privacy, clear all.
$profiles = netsh wlan show profiles | Select-String "Profil" 
if ($profiles) {
    foreach ($line in $profiles) {
        $parts = $line.ToString().Split(":")
        if ($parts.Count -gt 1) {
            $ssid = $parts[1].Trim()
            netsh wlan delete profile name="$ssid" | Out-Null
        }
    }
}
Write-Host " Done." -ForegroundColor Green

# 7. CLEAR DNS CACHE AGAIN
Write-Host "   + Flushing DNS..." -NoNewline
Clear-DnsClientCache
Write-Host " Done." -ForegroundColor Green

# 8. SPECIFIC REGISTRY CLEANUP (Erik/PII)
Write-Host "   + Sanitizing Registry (Spelling, AppPaths)..." -NoNewline
# Remove User Dictionary (often contains name)
Remove-Item -Path "HKCU:\Software\Microsoft\Spelling\Dictionaries\_Global_" -Recurse -ErrorAction SilentlyContinue
# Fix Brave Path (remove hardcoded user path)
$bravePath = "HKCU:\Software\Microsoft\Windows\CurrentVersion\App Paths\brave.exe"
if (Test-Path $bravePath) {
    Remove-Item -Path $bravePath -Recurse -ErrorAction SilentlyContinue 
}
Write-Host " Done." -ForegroundColor Green

Write-Host "`n[DONE] System is sanitized from local forensic traces." -ForegroundColor Cyan
Write-Host "Note: File deletion traces (MFT) might still exist on SSD, but content is gone." -ForegroundColor Gray
