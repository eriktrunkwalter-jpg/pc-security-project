# VerifySystemState.ps1
# Checks BitLocker, VBS, Telemetry, and DNS status
# Self-elevates for accurate reading

# Self-Elevation to Administrator
if (!([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Start-Process PowerShell -Verb RunAs "-NoProfile -ExecutionPolicy Bypass -File `"$PSCommandPath`""
    Exit
}

$ErrorActionPreference = "SilentlyContinue"

Write-Host ">>> SYSTEM VERIFICATION REPORT (ADMIN) <<<" -ForegroundColor Cyan

# 1. BitLocker Check
Write-Host "`n[1] BitLocker Encryption" -ForegroundColor Yellow
try {
    $bl = Get-BitLockerVolume -MountPoint C:
    if ($bl) {
        Write-Host "   Status:       $($bl.ProtectionStatus)"
        Write-Host "   Method:       $($bl.EncryptionMethod)"
        Write-Host "   Percentage:   $($bl.EncryptionPercentage)%"
        
        if ($bl.EncryptionMethod -like "*XtsAes256*" -and $bl.EncryptionPercentage -eq 100) {
            Write-Host "   Result: PASS (XTS-AES 256, Fully Encrypted)" -ForegroundColor Green
        } else {
            Write-Host "   Result: WARNING (Check details above)" -ForegroundColor Red
        }
    } else {
        Write-Host "   Result: FAIL (BitLocker not detected)" -ForegroundColor Red
    }
} catch {
    Write-Host "   Result: FAIL (Access Denied)" -ForegroundColor Red
}

# 2. VBS / Virtualization Security (Crash Prevention)
Write-Host "`n[2] VBS / Hypervisor Security" -ForegroundColor Yellow
$vbsPath = "HKLM:\SYSTEM\CurrentControlSet\Control\DeviceGuard"
$vbsKey = Get-ItemProperty -Path $vbsPath -Name "EnableVirtualizationBasedSecurity" -ErrorAction SilentlyContinue

if ($vbsKey -ne $null -and $vbsKey.EnableVirtualizationBasedSecurity -eq 0) {
    Write-Host "   VBS Registry: Disabled (Correct for stability)" -ForegroundColor Green
} elseif ($vbsKey -eq $null) {
     Write-Host "   VBS Registry: Not Configured (Default). Setting it to Disabled to be safe..." -ForegroundColor Yellow
     # Fix it right here
     New-Item -Path $vbsPath -Force | Out-Null
     Set-ItemProperty -Path $vbsPath -Name "EnableVirtualizationBasedSecurity" -Value 0
     Write-Host "   -> FIXED: VBS explicitly disabled." -ForegroundColor Green
} else {
    Write-Host "   VBS Registry: Enabled (Risk of crash)" -ForegroundColor Red
    # Fix it right here
    Set-ItemProperty -Path $vbsPath -Name "EnableVirtualizationBasedSecurity" -Value 0
    Write-Host "   -> FIXED: VBS explicitly disabled." -ForegroundColor Green
}

# 3. Telemetry & Privacy
Write-Host "`n[3] Telemetry & Privacy" -ForegroundColor Yellow
$tel = Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection" -Name "AllowTelemetry" -ErrorAction SilentlyContinue
if ($tel.AllowTelemetry -eq 0) {
    Write-Host "   Telemetry:    Blocked (Value 0)" -ForegroundColor Green
} else {
    Write-Host "   Telemetry:    Not fully blocked. Fixing..." -ForegroundColor Red
    Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection" -Name "AllowTelemetry" -Value 0
    Write-Host "   -> FIXED: Telemetry blocked." -ForegroundColor Green
}

# 4. DNS / Network (Anonymity)
Write-Host "`n[4] DNS Configuration" -ForegroundColor Yellow
$dns = Get-DnsClientServerAddress -InterfaceAlias "Wi-Fi", "Ethernet" | Where-Object {$_.ServerAddresses.Count -gt 0}
if ($dns) {
    foreach ($iface in $dns) {
        Write-Host "   Interface: $($iface.InterfaceAlias)"
        Write-Host "   DNS Servers: $($iface.ServerAddresses -join ', ')"
        
        # Check for Cloudflare (1.1.1.1) or Quad9 (9.9.9.9)
        if ($iface.ServerAddresses -contains "1.1.1.1" -or $iface.ServerAddresses -contains "9.9.9.9") {
            Write-Host "   Result: PASS (Secure DNS detected)" -ForegroundColor Green
        } else {
            Write-Host "   Result: WARNING (Using standard/ISP DNS)" -ForegroundColor Yellow
        }
    }
} else {
    Write-Host "   No active network adapters found." -ForegroundColor Gray
}

Write-Host "`n>>> VERIFICATION COMPLETE <<<" -ForegroundColor Cyan
Read-Host "Press Enter to exit..."
